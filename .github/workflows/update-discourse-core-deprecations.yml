name: Update Core Discourse Deprecations
on:
  schedule:
    - cron: '0 0 * * 1' # run every Monday 00:00 UTC
  workflow_dispatch:

jobs:
  update-ember-deprecations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: discourse/discourse
          path: 'discourse-core'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: yarn

      - name: Yarn install
        run: yarn install

      - name: Run deprecation script
        id: run-script
        run: |
          node ./scripts/update_discourse_core_deprecations.mjs ./discourse-core
          echo "::set-output name=files-to-debug::$(cat files_to_debug.txt)"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: Update discourse core deprecations
          title: Update Discourse Core Deprecations
          body: |
            This PR updates the list of Discourse deprecations in the `deprecation-ids.yml` file.
            Files to debug:
            ${{ steps.run-script.outputs.files-to-debug }}
          branch: update-discourse-core-deprecations
          delete-branch: true
          add-paths: |
            ./lib/deprecation_collector/deprecation-ids.yml
